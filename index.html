<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>白秘伝計算ツール (Web版)</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo">
                <span class="material-icons-round">auto_awesome</span>
                <h1>白秘伝計算 (Web)</h1>
            </div>
            <nav class="app-nav">
                <button class="nav-btn active" data-tab="tab-calc">
                    <span class="material-icons-round">calculate</span>
                    計算
                </button>
                <button class="nav-btn" data-tab="tab-family">
                    <span class="material-icons-round">family_restroom</span>
                    所持秘伝
                </button>
                <button class="nav-btn" data-tab="tab-def">
                    <span class="material-icons-round">edit_note</span>
                    定義
                </button>
                <button class="nav-btn" data-tab="tab-history">
                    <span class="material-icons-round">history</span>
                    履歴
                </button>
            </nav>
        </header>

        <main class="app-content">
            <!-- TAB: Calculation -->
            <section id="tab-calc" class="tab-content active">
                <div class="card">
                    <h2>目標ステータス設定</h2>
                    <div class="form-grid target-stats-grid">
                        <div class="input-group">
                            <label>ライフ</label>
                            <input type="number" id="target-life" class="stat-input" placeholder="0">
                        </div>
                        <div class="input-group">
                            <label>ちから</label>
                            <input type="number" id="target-pow" class="stat-input" placeholder="0">
                        </div>
                        <div class="input-group">
                            <label>かしこさ</label>
                            <input type="number" id="target-int" class="stat-input" placeholder="0">
                        </div>
                        <div class="input-group">
                            <label>命中</label>
                            <input type="number" id="target-ski" class="stat-input" placeholder="0">
                        </div>
                        <div class="input-group">
                            <label>回避</label>
                            <input type="number" id="target-spd" class="stat-input" placeholder="0">
                        </div>
                        <div class="input-group">
                            <label>丈夫さ</label>
                            <input type="number" id="target-def" class="stat-input" placeholder="0">
                        </div>
                        <div class="input-group">
                            <label>能力pt</label>
                            <input type="number" id="target-pt" class="stat-input" placeholder="0">
                        </div>
                        <div class="input-group full-width">
                            <label>相性倍率</label>
                            <select id="compatibility-ratio" class="select-input">
                                <option value="1.3">👑✨ 1.30</option>
                                <option value="1.25">👑 1.25</option>
                                <option value="1.2">☆ 1.20</option>
                                <option value="1.15">◎ 1.15</option>
                                <option value="1.1">○ 1.10</option>
                                <option value="1.05">△ 1.05</option>
                                <option value="1.0">× 1.00</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>青秘伝数値設定</h2>
                    <div class="form-grid blue-stats-grid">
                        <div class="input-group"><label>ライフ</label><input type="number" id="blue-life"
                                class="stat-input" placeholder="0"></div>
                        <div class="input-group"><label>ちから</label><input type="number" id="blue-pow" class="stat-input"
                                placeholder="0"></div>
                        <div class="input-group"><label>かしこさ</label><input type="number" id="blue-int"
                                class="stat-input" placeholder="0"></div>
                        <div class="input-group"><label>命中</label><input type="number" id="blue-ski" class="stat-input"
                                placeholder="0"></div>
                        <div class="input-group"><label>回避</label><input type="number" id="blue-spd" class="stat-input"
                                placeholder="0"></div>
                        <div class="input-group"><label>丈夫さ</label><input type="number" id="blue-def" class="stat-input"
                                placeholder="0"></div>
                    </div>
                </div>

                <div class="action-area" style="display: flex; gap: 1rem;">
                    <button id="btn-calculate" class="primary-btn">
                        <span class="material-icons-round">play_arrow</span>
                        計算実行
                    </button>
                    <button id="btn-cancel" class="secondary-btn hidden">
                        <span class="material-icons-round">stop</span>
                        キャンセル
                    </button>
                </div>

                <div id="result-area" class="card result-card hidden">
                    <h3>計算結果</h3>
                    <div class="result-actions">
                        <button id="btn-copy" class="secondary-btn small-btn">クリップボードにコピー</button>
                    </div>
                    <pre id="result-text"></pre> <!-- For raw text copy -->
                    <div id="result-html"></div> <!-- For visual display -->
                </div>
            </section>

            <!-- TAB: Family Tree (Owned Secrets) -->
            <section id="tab-family" class="tab-content">
                <div class="family-tree-container">
                    <!-- 6 Family Members -->
                    <div class="family-member-card" data-member="father">
                        <h3>父親</h3>
                        <div class="secret-list" id="list-father"></div>
                        <button class="add-secret-btn" onclick="addSecretToMember('father')">+ 秘伝追加</button>
                    </div>
                    <div class="family-member-card" data-member="f-gf">
                        <h3>父方祖父</h3>
                        <div class="secret-list" id="list-f-gf"></div>
                        <button class="add-secret-btn" onclick="addSecretToMember('f-gf')">+ 秘伝追加</button>
                    </div>
                    <div class="family-member-card" data-member="f-gm">
                        <h3>父方祖母</h3>
                        <div class="secret-list" id="list-f-gm"></div>
                        <button class="add-secret-btn" onclick="addSecretToMember('f-gm')">+ 秘伝追加</button>
                    </div>
                    <div class="family-member-card" data-member="mother">
                        <h3>母親</h3>
                        <div class="secret-list" id="list-mother"></div>
                        <button class="add-secret-btn" onclick="addSecretToMember('mother')">+ 秘伝追加</button>
                    </div>
                    <div class="family-member-card" data-member="m-gf">
                        <h3>母方祖父</h3>
                        <div class="secret-list" id="list-m-gf"></div>
                        <button class="add-secret-btn" onclick="addSecretToMember('m-gf')">+ 秘伝追加</button>
                    </div>
                    <div class="family-member-card" data-member="m-gm">
                        <h3>母方祖母</h3>
                        <div class="secret-list" id="list-m-gm"></div>
                        <button class="add-secret-btn" onclick="addSecretToMember('m-gm')">+ 秘伝追加</button>
                    </div>
                </div>
                <!-- Controls for Family Data -->
                <div class="card" style="margin-top: 1rem;">
                    <h3>データ管理</h3>
                    <div class="history-controls">
                        <button class="secondary-btn small-btn" onclick="exportFamilyData()">
                            <span class="material-icons-round">download</span>
                            所持状況をエクスポート
                        </button>
                        <button class="secondary-btn small-btn"
                            onclick="document.getElementById('import-family-file').click()">
                            <span class="material-icons-round">upload</span>
                            所持状況をインポート
                        </button>
                        <input type="file" id="import-family-file" accept=".json" style="display: none;"
                            onchange="importFamilyData(this)">
                    </div>
                </div>
            </section>

            <!-- TAB: White Secret Definitions -->
            <section id="tab-def" class="tab-content">
                <div class="card">
                    <div class="header-with-action">
                        <h2>白秘伝定義</h2>
                        <div class="def-actions" style="display: flex; gap: 0.5rem;">
                            <button class="secondary-btn small-btn" onclick="exportDefinitions()">
                                <span class="material-icons-round">download</span>
                                エクスポート
                            </button>
                            <button class="secondary-btn small-btn"
                                onclick="document.getElementById('import-def-file').click()">
                                <span class="material-icons-round">upload</span>
                                インポート
                            </button>
                            <input type="file" id="import-def-file" accept=".json" style="display: none;"
                                onchange="importDefinitions(this)">
                            <button class="secondary-btn" onclick="openDefModal()">+ 新規定義</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table" id="def-table">
                            <thead>
                                <tr>
                                    <th>秘伝名</th>
                                    <th>ステータス詳細</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- TAB: History -->
            <section id="tab-history" class="tab-content">
                <div class="card">
                    <h2>計算履歴</h2>
                    <div class="history-controls">
                        <button class="secondary-btn small-btn" id="btn-reset-history">
                            <span class="material-icons-round">delete_outline</span>
                            履歴を全削除
                        </button>
                        <button class="primary-btn small-btn" id="btn-copy-history">
                            <span class="material-icons-round">content_copy</span>
                            結果をコピー (TSV)
                        </button>
                    </div>
                    <div class="history-table-container">
                        <table class="history-table" id="history-table">
                            <!-- Dynamic Content -->
                        </table>
                        <div id="history-empty-msg" class="empty-msg" style="display:none;">
                            履歴はありません
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modal for Definition (Add/Edit) -->
    <div id="def-modal" class="modal hidden">
        <div class="modal-content large-modal">
            <h3>秘伝定義編集</h3>
            <div class="modal-form"> <!-- Wrapper for scrolling -->
                <div class="form-grid">
                    <div class="input-group full-width">
                        <label>秘伝名</label>
                        <input type="text" id="def-name" placeholder="例: 傷だらけのプライド秘伝">
                        <label class="checkbox-label"
                            style="display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem; cursor:pointer;">
                            <input type="checkbox" id="def-is-exception"> <span style="font-size:0.9rem;">集計から除外
                                (例外)</span>
                        </label>
                    </div>

                    <div class="stat-rows-container">
                        <label>ステータス定義</label>
                        <div id="def-stat-rows">
                            <!-- Stat Rows injected here -->
                        </div>
                        <button class="rich-add-btn" onclick="addStatRow()">
                            <span class="material-icons-round">add_circle_outline</span>
                            ステータス行を追加
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="secondary-btn" onclick="closeModal('def-modal')">キャンセル</button>
                <button class="primary-btn" onclick="saveDefinition()">保存</button>
            </div>
        </div>
    </div>

    <!-- Modal for Adding Possessed Secret -->
    <div id="add-secret-modal" class="modal hidden">
        <div class="modal-content">
            <h3>所持秘伝を追加</h3>
            <div class="form-grid modal-form">
                <div class="input-group full-width">
                    <label>秘伝を選択</label>
                    <select id="add-secret-select" class="select-input">
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div class="input-group full-width">
                    <label>ランク (★)</label>
                    <div class="star-rating-widget">
                        <span class="material-icons-round star-icon" onclick="selectStarNew(1)" id="star-1">star</span>
                        <span class="material-icons-round star-icon" onclick="selectStarNew(2)" id="star-2">star</span>
                        <span class="material-icons-round star-icon" onclick="selectStarNew(3)" id="star-3">star</span>
                    </div>
                    <input type="hidden" id="add-secret-star" value="3">
                </div>
            </div>
            <div class="modal-actions">
                <button class="secondary-btn" onclick="closeModal('add-secret-modal')">キャンセル</button>
                <button class="primary-btn" onclick="confirmAddSecret()">追加</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>

</html>